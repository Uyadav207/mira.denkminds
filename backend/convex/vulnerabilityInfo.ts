import { query, mutation } from "./_generated/server";
import { v } from "convex/values";

export const fetchVulnerabilityInfoByVId = query({
	args: {
		vulnerabilityId: v.id("vulnerabilities"),
	},
	handler: async (ctx, { vulnerabilityId }) => {
		const vulnerabilityInfo = await ctx.db
			.query("vulnerabilityInfo")
			.withIndex("by_vulnerabilityId", (q) =>
				q.eq("vulnerabilityId", vulnerabilityId),
			)
			.collect();
		return vulnerabilityInfo;
	},
});

export const saveVulnerabilityInfo = mutation({
	args: {
		vulnerabilityId: v.id("vulnerabilities"),
		riskLevel: v.string(),
		cweId: v.string(),
		cveIds: v.array(v.string()),
		description: v.string(),
		affectedUrls: v.array(
			v.object({
				uri: v.string(),
				method: v.string(),
				attack: v.string(),
				evidence: v.string(),
			}),
		),
		solution: v.string(),
		confidence: v.string(),
		reference: v.string(),
	},
	handler: async (
		ctx,
		{
			vulnerabilityId,
			riskLevel,
			cweId,
			cveIds,
			description,
			affectedUrls,
			solution,
			confidence,
			reference,
		},
	) => {
		const infoId = await ctx.db.insert("vulnerabilityInfo", {
			vulnerabilityId,
			riskLevel,
			cweId,
			cveIds,
			description,
			affectedUrls,
			solution,
			confidence,
			reference,
		});

		return { infoId };
	},
});
