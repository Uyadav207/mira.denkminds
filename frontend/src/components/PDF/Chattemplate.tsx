import { useRef, useEffect, useState } from "react";
import { Button } from "@components/ui/button";
import { useReactToPrint } from "react-to-print";
import { useQuery } from "convex/react";
// biome-ignore lint/style/useImportType: <explanation>
import { Id } from "../../convex/_generated/dataModel";
import { api } from "../../convex/_generated/api";
import { useNavigate, useParams } from "react-router-dom";
import { ArrowLeft } from "lucide-react";
import useStore from "../../store/store";
import { Card, CardContent } from "../ui/card";

type Summary = {
	_id: Id<"summaries">;
	title: string;
	content: string;
	createdAt: string;
};

export function ChatTemplate() {
	const { _id } = useParams<{ _id: string }>();
	const templateRef = useRef<HTMLDivElement>(null);
	const [chatSummary, setChatSummary] = useState<Summary | null>(null);
	// const [isPrinting, setIsPrinting] = useState(false);
	const user = useStore((state) => state.user);

	if (!user) return null;

	const fetchedSummary = useQuery(api.summaries.getSummariesByUserId, {
		userId: String(user.id),
	}) as Summary[];

	const navigate = useNavigate();
	// const { chatReportId } = useParams<{ chatReportId: string }>();
	// const { chatReportId } = useParams<{ chatReportId: string }>();
	// console.log("fileId", chatReportId);

	// useEffect(() => {
	// 	if (chatReportId) {
	// 		console.log("fileId", chatReportId);

	// 	}
	// }, [chatReportId]);

	// const file = useQuery(
	// 	api.reports.getFileById,
	// 	fileId && {
	// 		fileId: String(fileId),
	// 	},
	// );

	useEffect(() => {
		if (fetchedSummary) {
			const foundSummary = fetchedSummary.find(
				(summary) => summary._id === _id,
			);
			setChatSummary(foundSummary || null);
		}
	}, [fetchedSummary, _id]);

	const handlePrint = useReactToPrint({
		contentRef: templateRef,
		documentTitle: chatSummary?.title || "Security Report",
		onBeforePrint: () => {
			// setIsPrinting(true);
			return Promise.resolve();
		},
		onAfterPrint: () => {
			// setIsPrinting(false);
		},
	});

	return (
		<div className="relative p-8">
			<div className="flex justify-between items-center absolute top-4 left-4 right-4">
				<Button variant="outline" onClick={() => navigate(-1)}>
					<ArrowLeft className="mr-2 h-4 w-4" />
					Back to Files
				</Button>
				{/* Print Button */}
				<Button onClick={handlePrint} variant="outline">
					Print Chat Summary
				</Button>
			</div>

			<Card className="max-w-[850px] mx-auto bg-white">
				<CardContent ref={templateRef} className="p-8">
					{/* Header */}
					<div className="flex justify-between items-center border-b border-gray-200 pb-4">
						<div className="flex items-center gap-3">
							{/* <img src={Logo} alt="Logo" className="h-8 w-auto" /> */}
							<span className="text-sm font-medium text-gray-600">
								denkMinds
							</span>
						</div>
						<div className="text-sm text-gray-500">
							https://denkminds.vercel.app
						</div>
					</div>

					{/* Title Section */}
					<div className="my-8">
						<h1 className="text-2xl font-semibold text-gray-900 mb-6">
							{chatSummary?.title || "Security Report"}
						</h1>
						<div className="text-sm text-gray-600 space-y-1">
							<p>Generated by: {user.username}</p>
							<p>Date: {new Date().toLocaleDateString()}</p>
						</div>
					</div>

					{/* Content Section */}
					<div className="space-y-6">
						{chatSummary ? (
							<>
								<div className="space-y-4">
									<h2 className="text-xl font-semibold text-gray-900">
										1. Executive Summary
									</h2>
									{chatSummary.content.split("\n").map((paragraph, index) => {
										// Remove markdown-style headers
										const cleanParagraph = paragraph.replace(
											/^(###|##)\s+/,
											"",
										);
										return (
											<p
												key={`${paragraph}-${
													// biome-ignore lint/suspicious/noArrayIndexKey: <explanation>
													index
												}`}
												className="text-sm leading-relaxed text-gray-700"
											>
												{cleanParagraph.trim()}
											</p>
										);
									})}
								</div>
								<div className="text-xs text-gray-500 mt-4">
									Report generated on:{" "}
									{new Date(chatSummary.createdAt).toLocaleString()}
								</div>
							</>
						) : (
							<div className="text-center py-8 text-gray-500">
								Loading report content...
							</div>
						)}
					</div>

					{/* Footer */}
					<div className="mt-12 pt-4 border-t border-gray-200">
						<div className="flex justify-between items-center text-xs text-gray-500">
							<p>Â© 2025 denkMinds. All rights reserved.</p>
							<div className="flex items-center gap-4">
								<span className="uppercase font-medium">Sensitive</span>
								<span>Page 1 of 1</span>
							</div>
						</div>
					</div>
				</CardContent>
			</Card>
		</div>
	);
}
